<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../team-listing/team-listing.html">
<script src="../../scripts/jquery-2.2.2.min.js"></script>


<dom-module id="team-list">
  <template>
  <style>
  ul {
    list-style: none;
    padding: 0;
  }
  li + li {
    border-top: solid 1px #BDBDBD;
  }
  #rankings-explain-fab {
    position: fixed;
    right: 25px;
    bottom: 25px;
  }
  </style>
  <ul>

    <template is="dom-repeat" items="{{teams}}">
      <li>
        <team-listing
          rank="{{item.rank}}"
          name="{{item.name}}"
          wins="{{item.wins}}"
          ties="{{item.ties}}"
          losses="{{item.losses}}"
          rankpts="{{item.rankpts}}"
          qualpts="{{item.qualpts}}">
        </team-listing>
      </li>
    </template>
  </ul>
  <paper-fab id="rankings-explain-fab" icon="icons:help-outline" on-tap="showExplanation"></paper-fab>
  <paper-dialog id="explain" fitInto="#team-list" with-backdrop="true">
    <h2>How rankings are calculated</h2>
    <paper-dialog-scrollable>
      <p>Rankings are calculated as follows:</p>
      <p><span style="font-weight: bold;">Ranking Points</span> are 2*(number of wins) + 1*(number of losses).</p>
      <p><span style="font-weight: bold;">Qualification Points</span> are the sum of a team's difference in scores against their opponents' scores. For example, if a team wins 15-0 in one match and then loses 0-15 in another match, they have 0 qualification points.</p>
      <p>Qualification points are used to break ties between ranking points.</p>
    </paper-dialog-scrollable>
    <div class="buttons">
      <paper-button dialog-dismiss>OK</paper-button>
    </div>
  </paper-dialog>
</template>
<script>
Polymer({
  is: "team-list",
  properties: {
    googleSheetsKey: String,
    sheetNumber: String,
    teams: {
      type: Array,
      notify: true,
      reflectToAttribute: true
    }
  },
  ready: function() {
    this.teams = [];

    var xmlhttp = new XMLHttpRequest();
    var spreadsheetUrl = `https://spreadsheets.google.com/feeds/list/${this.googleSheetsKey}/${this.sheetNumber}/public/basic?alt=json`;
    var update = function(xmlhttp, context) {
      return function() {
        if (xmlhttp.readyState == 4 & xmlhttp.status == 200) {
          var myArr = JSON.parse(xmlhttp.responseText);
          var entries = myArr['feed']['entry'];
          for (i = 0; i < entries.length; i++) {

            var content = entries[i]["content"]["$t"];
            // Inserts quotes so that the JSON can be evaluated as a JS object
            content = content.replace(/([:,]\s)/g, '"$1"');
            // Catches accidental new lines in Google Sheet
            content = content.replace(/(\r\n|\n|\r)/gm,"");
            content = '{"' + content + '"}';

            team = JSON.parse(content);
            var rank = entries[i]["title"]["$t"];
            if (rank.substring(0, 3) == "Row") {rank = "";}
            var name = team["teamname"];
            var wins = team["wins"];
            var ties = team["ties"];
            var losses = team["losses"];
            var rankpts = team["rankingpts"];
            var qualpts = team["qualificationpts"];
            context.push('teams', {
              rank: rank,
              name: name,
              wins: wins,
              ties: ties,
              losses: losses,
              rankpts: rankpts,
              qualpts: qualpts
            });
          }
        }
      };
    };
    xmlhttp.onreadystatechange = update(xmlhttp, this);
    xmlhttp.open("GET", spreadsheetUrl, true);
    xmlhttp.send();
  },
  showExplanation: function() {
    this.$.explain.open();
  }
});


</script>
</dom-module>
